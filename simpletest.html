<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <link rel="stylesheet" type="text/css" href="./build/css/flex.css"> -->
    <title>Test XHR Premature Timeout</title>
    <style>
        body {
            font-family: sans-serif;
        }
    </style></head>
<body>
    <h1>Test XHR Premature Timeout</h1>

    <i>In response to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=716283#c3">https://bugs.chromium.org/p/chromium/issues/detail?id=716283#c3</a></i>

    <p>Enter an address that won't answer:
        <input type=text id="address" value="http://123.45.67.89" /> (good choice: <i>http://123.45.67.89</i>)
        <br /><br />
        The code will continually send an XMLHttpRequest to it with a long timeout.
        Open the Console to monitor its progess, and the events surrounding its operation.
    </p>
    <h3>Counts of error status</h3>
    <ul>
        <li>Load: <span id="load"></span></li>
        <li>Error: <span id="error"></span> (Bad!)</li>
        <li>Abort: <span id="abort"></span></li>
        <li>Timeout: <span id="timeout"></span> (Good!)</li>
    </ul>


    <script>
        const counts = {
          load: 0,
          error: 0,
          abort: 0,
          timeout: 0
        };
      const checkInterval = 10 * 1000;
      const requestTimeout = 6 * 1000;
      let startTime = new Date();

      CheckAlive();
      setInterval (CheckAlive, checkInterval);

      function LogCompletion(text) {
        const endTime = new Date();
        const elapsed = endTime - startTime;
        console.log("Elapsed: " + elapsed + " msec; Status was: " + text);
        counts[text] += 1;
        for (let prop in counts){
            document.getElementById(prop).innerHTML = counts[prop];
        }
      }

      function CheckAlive() {

        const host = document.getElementById('address').value;
//         console.log("Called CheckAlive: "+host + "timeout is "+ requestTimeout +" msec");

        const req = new XMLHttpRequest();             // this is the request we'll use to test host_port

        req.addEventListener("load"   , function() { LogCompletion('load') });    // Got some kind of response back
        req.addEventListener("error"  , function() { LogCompletion('error')  });    // CORS errors show the server is there
        req.addEventListener("abort"  , function() { LogCompletion('abort')  });    // Somebody aborted test (don't know how)
        req.addEventListener("timeout", function() { LogCompletion("timeout")  });    // timed out - presumably couldn't connect

        // LogToWindow("Testing " + url);
        req.open('GET', host, true);                        // async http GET from host
        req.timeout = requestTimeout;                       // long-ish timer
        req.ontimeout = (e) => { console.log("timeout from ontimeout - That's OK!")};
        startTime = new Date();
        req.send();
      }

    </script>

</body>
</html>
