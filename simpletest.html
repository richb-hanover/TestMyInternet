<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <link rel="stylesheet" type="text/css" href="./build/css/flex.css"> -->
    <title>Test XHR Premature Timeout</title>
    <style>
        body {
            font-family: sans-serif;
        }
        td, th {
            text-align: right;
            padding: 4px;
        }
    </style></head>
<body>
    <h1>Test XHR Premature Timeout</h1>

    <p>
        This code will continually send an XMLHttpRequest to a host with a long timeout.
        Open the Console to monitor its progress, and the events surrounding its operation.
    </p>
    <p>
        Demo code created in response to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=716283#c3">https://bugs.chromium.org/p/chromium/issues/detail?id=716283#c3</a></i>
    <ul>
        <li>Enter an address that won't answer:
            <input type=text id="addressStr" value="http://123.45.67.89" /> (good choice: <i>http://123.45.67.89</i>)
        </li>
        <li>
            Enter a timeout: <input type=text id="timeoutStr" value="1000" /> <i>msec</i>
        </li>
    </ul>
    </p>
    <h3 id="browserid"></h3>
    <h4>Counts of error status & and recent elapsed times</h4>
    <table>
        <tr><th>Event</th>   <th>Count</th>         <th>Recent msec</th></tr>
        <tr><td>Load:</td>   <td id="load"></td>    <td id="loadelapsed">       </td></tr>
        <tr><td>Error:</td>  <td id="error"></td>   <td id="errorelapsed">      </td></tr>
        <tr><td>Abort:</td>  <td id="abort"></td>   <td id="abortelapsed">      </td></tr>
        <tr><td>Timeout:</td><td id="timeout"></td> <td id="timeoutelapsed">    </td></tr>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.12/ua-parser.min.js"></script>
    <script>
        const counts = {
          load: 0,
          error: 0,
          abort: 0,
          timeout: 0
        };
        const recentElapsed = {
          load: 0,
          error: 0,
          abort: 0,
          timeout: 0
        };

        const checkInterval = 30 * 1000;
        const requestTimeout = 6 * 1000;
        var startTime = new Date();
        var parser = new UAParser();
        var browserInfo = parser.getResult();
        var browserID = browserInfo.browser.name + " " + browserInfo.browser.version;
        browserID += " (" + browserInfo.os.name + " " + browserInfo.os.version + ")";

      document.getElementById('browserid').innerHTML = browserID;
      CheckAlive();
      setInterval (CheckAlive, checkInterval);

      function LogCompletion(text) {
        const endTime = new Date();
        const elapsed = endTime - startTime;
        console.log("Elapsed: " + elapsed + " msec; Status was: " + text);
        counts[text] += 1;
        recentElapsed[text] = elapsed;
        for (let prop in counts){
          document.getElementById(prop).innerHTML = counts[prop];
          document.getElementById(prop+'elapsed').innerHTML = recentElapsed[prop].toString();
        }
      }

      function CheckAlive() {

        const host = document.getElementById('addressStr').value;
        const timeout = document.getElementById('timeoutStr').value;
        const userTimeout = parseInt(timeout);

//        console.log("Called CheckAlive: "+host + "timeout is "+ userTimeout +" msec");

        const req = new XMLHttpRequest();             // this is the request we'll use to test host_port

        req.addEventListener("load"   , function() { LogCompletion('load') });    // Got some kind of response back
        req.addEventListener("error"  , function() { LogCompletion('error')  });    // CORS errors show the server is there
        req.addEventListener("abort"  , function() { LogCompletion('abort')  });    // Somebody aborted test (don't know how)
        req.addEventListener("timeout", function() { LogCompletion('timeout')  });    // timed out - presumably couldn't connect

        // LogToWindow("Testing " + url);
        req.open('GET', host, true);                        // async http GET from host
        req.timeout = userTimeout;                       // long-ish timer
        // 'ontimeout' events seem always to be paired with addEventListener 'timeout' events, so comment this out
//        req.ontimeout = (e) => { console.log("timeout from ontimeout - That's OK!")};
        startTime = new Date();
        req.send();
      }
    </script>
</body>
</html>
